class m{constructor(){this.currentUserRole=window.currentUserRole||""}validateProgramData(e){return!e||typeof e!="object"?!1:e.program_id&&e.program_name}formatDate(e){if(!e)return"Not set";try{return new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"})}catch{return console.warn("Invalid date string:",e),"Invalid date"}}getRatingConfig(e){const t={not_started:{label:"Not Started",class:"secondary",icon:"fas fa-hourglass-start",order:4},on_track_for_year:{label:"On Track for Year",class:"warning",icon:"fas fa-calendar-check",order:2},monthly_target_achieved:{label:"Monthly Target Achieved",class:"success",icon:"fas fa-check-circle",order:1},severe_delay:{label:"Severe Delays",class:"danger",icon:"fas fa-exclamation-triangle",order:3}};return t[e]||t.not_started}canEditProgram(e){return e?this.currentUserRole==="focal"||this.currentUserRole==="admin"||e.created_by&&e.created_by==window.currentUserId:!1}canDeleteProgram(e){return e?this.currentUserRole==="focal"||this.currentUserRole==="admin"||e.created_by&&e.created_by==window.currentUserId:!1}filterBySearch(e,t){if(!t||t.trim()==="")return e;const i=t.toLowerCase().trim();return e.filter(n=>{const r=(n.program_name||"").toLowerCase(),a=(n.program_number||"").toLowerCase(),l=(n.initiative_name||"").toLowerCase();return r.includes(i)||a.includes(i)||l.includes(i)})}filterByRating(e,t){if(!t||t==="")return e;const n={"target-achieved":"monthly_target_achieved","on-track-yearly":"on_track_for_year","severe-delay":"severe_delay","not-started":"not_started"}[t]||t;return e.filter(r=>(r.rating||"not_started")===n)}filterByType(e,t){return!t||t===""?e:e.filter(i=>(i.is_assigned?"assigned":"created")===t)}filterByInitiative(e,t){return!t||t===""?e:t==="no-initiative"?e.filter(i=>!i.initiative_id):e.filter(i=>i.initiative_id==t)}sortPrograms(e,t,i="asc"){const n=[...e];return n.sort((r,a)=>{let l,o;switch(t){case"name":l=(r.program_name||"").toLowerCase(),o=(a.program_name||"").toLowerCase();break;case"initiative":l=(r.initiative_name||"zzz_no_initiative").toLowerCase(),o=(a.initiative_name||"zzz_no_initiative").toLowerCase();break;case"rating":const s=this.getRatingConfig(r.rating||"not_started"),d=this.getRatingConfig(a.rating||"not_started");l=s.order,o=d.order;break;case"date":l=new Date(r.updated_at||r.created_at||0).getTime(),o=new Date(a.updated_at||a.created_at||0).getTime();break;default:return 0}return l<o?i==="asc"?-1:1:l>o?i==="asc"?1:-1:0}),n}calculateStats(e){const t=e.length,i={},n={};return e.forEach(r=>{const a=r.rating||"not_started",l=r.is_assigned?"assigned":"created";i[a]=(i[a]||0)+1,n[l]=(n[l]||0)+1}),{total:t,byRating:i,byType:n}}truncateText(e,t=50){return!e||e.length<=t?e||"":e.substring(0,t-3)+"..."}escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}}class y{constructor(){this.logic=new m,this.currentSort={column:null,direction:"asc"}}init(){console.log("ðŸŽ¯ Initializing DOM handlers..."),this.initDeleteModal(),this.initSimpleMoreActions(),this.initTooltips(),this.initTableSorting(),this.updateCounters(),console.log("âœ… DOM handlers initialized")}initSimpleMoreActions(){document.addEventListener("click",e=>{e.target.closest(".more-actions-btn")||this.closeAllMenus()}),window.toggleMoreActions=(e,t,i)=>{this.toggleMoreActions(e,t,i)}}toggleMoreActions(e,t,i){this.closeAllMenus();let n=document.getElementById(`global-menu-${e}`);n||(n=this.createMenuOutsideTable(e,t)),this.positionMenu(n,i),this.showMenu(n)}createMenuOutsideTable(e,t){const i=document.createElement("div");return i.className="more-actions-menu",i.id=`global-menu-${e}`,i.style.position="fixed",i.style.display="none",i.style.zIndex="9999",i.innerHTML=`
            <div class="menu-header">
                <strong>${t}</strong>
            </div>
            <div class="menu-divider"></div>
            <a href="edit_program.php?id=${e}" class="menu-item">
                <i class="fas fa-edit"></i> Edit Program Details
            </a>
            <a href="edit_submission.php?program_id=${e}" class="menu-item">
                <i class="fas fa-file-edit"></i> Edit Latest Submission
            </a>
            <a href="add_submission.php?program_id=${e}" class="menu-item">
                <i class="fas fa-plus"></i> Add New Submission
            </a>
            <div class="menu-divider"></div>
            <a href="program_details.php?id=${e}" class="menu-item">
                <i class="fas fa-eye"></i> View Full Details
            </a>
        `,document.body.appendChild(i),i}positionMenu(e,t){const i=t.getBoundingClientRect(),n=220,r=200;let a=i.right-n,l=i.bottom+5;a<10&&(a=i.left),a+n>window.innerWidth-10&&(a=window.innerWidth-n-10),l+r>window.innerHeight-10&&(l=i.top-r-5),e.style.left=`${a}px`,e.style.top=`${l}px`}showMenu(e){e.style.display="block",e.classList.add("show"),e.classList.remove("hide")}hideMenu(e){e.classList.add("hide"),e.classList.remove("show"),setTimeout(()=>{e.style.display="none",e.classList.remove("hide")},200)}closeAllMenus(){document.querySelectorAll('.more-actions-menu[id^="global-menu-"]').forEach(e=>{e.style.display!=="none"&&this.hideMenu(e)})}initDeleteModal(){if(!document.getElementById("deleteModal")){console.warn("Delete modal not found");return}document.querySelectorAll(".trigger-delete-modal").forEach(n=>{n.addEventListener("click",r=>{const a=n.getAttribute("data-id"),l=n.getAttribute("data-name");this.setupDeleteModal(a,l)})});const t=document.getElementById("delete-continue-btn"),i=document.getElementById("delete-confirm-btn");t&&t.addEventListener("click",()=>{this.showDeleteStep2()}),i&&i.addEventListener("click",()=>{this.submitDeleteForm()})}setupDeleteModal(e,t){const i=new bootstrap.Modal(document.getElementById("deleteModal")),n=document.getElementById("program-id-input"),r=document.getElementById("program-name-display");n&&(n.value=e),r&&(r.textContent=t),this.showDeleteStep1(),i.show()}showDeleteStep1(){const e=document.getElementById("deleteStep1"),t=document.getElementById("deleteStep2"),i=document.getElementById("delete-continue-btn"),n=document.getElementById("delete-confirm-btn");e&&(e.style.display=""),t&&(t.style.display="none"),i&&(i.style.display=""),n&&(n.style.display="none")}showDeleteStep2(){const e=document.getElementById("deleteStep1"),t=document.getElementById("deleteStep2"),i=document.getElementById("delete-continue-btn"),n=document.getElementById("delete-confirm-btn");e&&(e.style.display="none"),t&&(t.style.display=""),i&&(i.style.display="none"),n&&(n.style.display="",n.focus())}submitDeleteForm(){const e=document.getElementById("delete-program-form");e&&e.submit()}initTooltips(){[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(t){return new bootstrap.Tooltip(t)})}initTableSorting(){document.querySelectorAll(".table th.sortable").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-sort");this.handleSort(t,e)})})}handleSort(e,t){let i="asc";this.currentSort.column===e&&this.currentSort.direction==="asc"&&(i="desc"),this.currentSort={column:e,direction:i},this.updateSortIndicators(t,i),this.sortTable(e,i,t.closest("table"))}updateSortIndicators(e,t){document.querySelectorAll(".table th.sortable .fas").forEach(n=>{n.className="fas fa-sort ms-1"});const i=e.querySelector(".fas");i&&(i.className=t==="asc"?"fas fa-sort-up ms-1":"fas fa-sort-down ms-1")}sortTable(e,t,i){const n=i.querySelector("tbody"),r=Array.from(n.querySelectorAll("tr")).filter(a=>!a.querySelector("td[colspan]"));r.sort((a,l)=>{let o,s;switch(e){case"name":o=a.querySelector(".program-name")?.textContent.trim()||"",s=l.querySelector(".program-name")?.textContent.trim()||"";break;case"initiative":o=a.querySelector("[data-initiative]")?.getAttribute("data-initiative")||"zzz_no_initiative",s=l.querySelector("[data-initiative]")?.getAttribute("data-initiative")||"zzz_no_initiative";break;case"rating":o=parseInt(a.querySelector("[data-rating-order]")?.getAttribute("data-rating-order")||"999"),s=parseInt(l.querySelector("[data-rating-order]")?.getAttribute("data-rating-order")||"999");break;case"date":o=a.querySelector("[data-date]")?.getAttribute("data-date")||"1970-01-01",s=l.querySelector("[data-date]")?.getAttribute("data-date")||"1970-01-01";break;default:return 0}if(e==="rating")return t==="asc"?o-s:s-o;{const d=o.localeCompare(s);return t==="asc"?d:-d}}),r.forEach(a=>n.appendChild(a))}updateCounters(){const e=document.querySelectorAll('#draftProgramsTable tbody tr:not([style*="display: none"])'),t=document.querySelectorAll('#finalizedProgramsTable tbody tr:not([style*="display: none"])'),i=document.querySelectorAll('#emptyProgramsTable tbody tr:not([style*="display: none"])'),n=Array.from(e).filter(d=>!d.querySelector("td[colspan]")).length,r=Array.from(t).filter(d=>!d.querySelector("td[colspan]")).length,a=Array.from(i).filter(d=>!d.querySelector("td[colspan]")).length,l=document.getElementById("draft-count"),o=document.getElementById("finalized-count"),s=document.getElementById("empty-count");l&&(l.textContent=n),o&&(o.textContent=r),s&&(s.textContent=a)}showToast(e,t,i="info"){typeof window.showToast=="function"?window.showToast(e,t,i):console.log(`${e}: ${t}`)}handleResize(){window.innerWidth<768?document.querySelectorAll(".initiative-display").forEach(t=>{t.style.display="none"}):document.querySelectorAll(".initiative-display").forEach(t=>{t.style.display=""})}setTableLoading(e,t){const i=document.querySelector(e);i&&(t?i.classList.add("table-loading"):i.classList.remove("table-loading"))}}class g{constructor(){this.logic=new m,this.activeFilters={draft:{},finalized:{},empty:{}}}init(){console.log("ðŸ” Initializing filters..."),this.initDraftFilters(),this.initFinalizedFilters(),this.initEmptyFilters(),console.log("âœ… Filters initialized")}initDraftFilters(){const e=document.getElementById("draftProgramSearch"),t=document.getElementById("draftRatingFilter"),i=document.getElementById("draftTypeFilter"),n=document.getElementById("draftInitiativeFilter"),r=document.getElementById("resetDraftFilters");e&&e.addEventListener("input",u(()=>{this.handleDraftFilter()},300)),t&&t.addEventListener("change",()=>{this.handleDraftFilter()}),i&&i.addEventListener("change",()=>{this.handleDraftFilter()}),n&&n.addEventListener("change",()=>{this.handleDraftFilter()}),r&&r.addEventListener("click",()=>{this.resetDraftFilters()})}initFinalizedFilters(){const e=document.getElementById("finalizedProgramSearch"),t=document.getElementById("finalizedRatingFilter"),i=document.getElementById("finalizedTypeFilter"),n=document.getElementById("finalizedInitiativeFilter"),r=document.getElementById("resetFinalizedFilters");e&&e.addEventListener("input",u(()=>{this.handleFinalizedFilter()},300)),t&&t.addEventListener("change",()=>{this.handleFinalizedFilter()}),i&&i.addEventListener("change",()=>{this.handleFinalizedFilter()}),n&&n.addEventListener("change",()=>{this.handleFinalizedFilter()}),r&&r.addEventListener("click",()=>{this.resetFinalizedFilters()})}initEmptyFilters(){const e=document.getElementById("emptyProgramSearch"),t=document.getElementById("emptyTypeFilter"),i=document.getElementById("emptyInitiativeFilter"),n=document.getElementById("resetEmptyFilters");e&&e.addEventListener("input",u(()=>{this.handleEmptyFilter()},300)),t&&t.addEventListener("change",()=>{this.handleEmptyFilter()}),i&&i.addEventListener("change",()=>{this.handleEmptyFilter()}),n&&n.addEventListener("click",()=>{this.resetEmptyFilters()})}handleDraftFilter(){const e=document.getElementById("draftProgramSearch")?.value||"",t=document.getElementById("draftRatingFilter")?.value||"",i=document.getElementById("draftTypeFilter")?.value||"",n=document.getElementById("draftInitiativeFilter")?.value||"";this.activeFilters.draft={search:e,rating:t,type:i,initiative:n},this.applyTableFilter("draftProgramsTable",this.activeFilters.draft),this.updateFilterBadges("draftFilterBadges",this.activeFilters.draft),this.updateCounters()}handleFinalizedFilter(){const e=document.getElementById("finalizedProgramSearch")?.value||"",t=document.getElementById("finalizedRatingFilter")?.value||"",i=document.getElementById("finalizedTypeFilter")?.value||"",n=document.getElementById("finalizedInitiativeFilter")?.value||"";this.activeFilters.finalized={search:e,rating:t,type:i,initiative:n},this.applyTableFilter("finalizedProgramsTable",this.activeFilters.finalized),this.updateFilterBadges("finalizedFilterBadges",this.activeFilters.finalized),this.updateCounters()}handleEmptyFilter(){const e=document.getElementById("emptyProgramSearch")?.value||"",t=document.getElementById("emptyTypeFilter")?.value||"",i=document.getElementById("emptyInitiativeFilter")?.value||"";this.activeFilters.empty={search:e,type:t,initiative:i},this.applyTableFilter("emptyProgramsTable",this.activeFilters.empty),this.updateFilterBadges("emptyFilterBadges",this.activeFilters.empty),this.updateCounters()}applyTableFilter(e,t){const i=document.getElementById(e);if(!i)return;i.querySelectorAll("tbody tr").forEach(r=>{if(r.querySelector("td[colspan]"))return;let a=!0;if(t.search&&t.search.trim()!==""){const l=t.search.toLowerCase().trim(),o=r.querySelector(".program-name")?.textContent.toLowerCase()||"",s=r.querySelector(".badge.bg-info")?.textContent.toLowerCase()||"",d=r.querySelector(".initiative-badge-card")?.textContent.toLowerCase()||"";a=a&&(o.includes(l)||s.includes(l)||d.includes(l))}if(t.rating&&t.rating!==""){const l=r.querySelector("[data-rating]")?.getAttribute("data-rating")||"",s={"target-achieved":"monthly_target_achieved","on-track-yearly":"on_track_for_year","severe-delay":"severe_delay","not-started":"not_started"}[t.rating]||t.rating;a=a&&l===s}if(t.type&&t.type!==""){const l=r.getAttribute("data-program-type")||"";a=a&&l===t.type}if(t.initiative&&t.initiative!==""){const l=r.querySelector("[data-initiative-id]")?.getAttribute("data-initiative-id")||"0";t.initiative==="no-initiative"?a=a&&(l==="0"||l===""):a=a&&l===t.initiative}r.style.display=a?"":"none"})}updateFilterBadges(e,t){const i=document.getElementById(e);i&&(i.innerHTML="",Object.entries(t).forEach(([n,r])=>{if(r&&r.trim()!==""){const a=this.createFilterBadge(n,r);i.appendChild(a)}}))}createFilterBadge(e,t){const i=document.createElement("span");i.className="filter-badge";let n=t;return e==="rating"?n={"target-achieved":"Monthly Target Achieved","on-track-yearly":"On Track for Year","severe-delay":"Severe Delays","not-started":"Not Started"}[t]||t:e==="type"?n={assigned:"Assigned",created:"Agency-Created"}[t]||t:e==="initiative"&&(t==="no-initiative"?n="Not Linked to Initiative":n=document.querySelector(`select option[value="${t}"]`)?.textContent||t),i.innerHTML=`
            ${this.capitalizeFirst(e)}: ${n}
            <button type="button" class="btn-close" aria-label="Remove filter"></button>
        `,i.querySelector(".btn-close").addEventListener("click",()=>{this.removeFilter(e,i)}),i}removeFilter(e,t){({search:["draftProgramSearch","finalizedProgramSearch","emptyProgramSearch"],rating:["draftRatingFilter","finalizedRatingFilter"],type:["draftTypeFilter","finalizedTypeFilter","emptyTypeFilter"],initiative:["draftInitiativeFilter","finalizedInitiativeFilter","emptyInitiativeFilter"]}[e]||[]).forEach(r=>{const a=document.getElementById(r);a&&(a.value="")}),t.remove(),this.handleDraftFilter(),this.handleFinalizedFilter(),this.handleEmptyFilter()}resetDraftFilters(){document.getElementById("draftProgramSearch").value="",document.getElementById("draftRatingFilter").value="",document.getElementById("draftTypeFilter").value="",document.getElementById("draftInitiativeFilter").value="",this.handleDraftFilter()}resetFinalizedFilters(){document.getElementById("finalizedProgramSearch").value="",document.getElementById("finalizedRatingFilter").value="",document.getElementById("finalizedTypeFilter").value="",document.getElementById("finalizedInitiativeFilter").value="",this.handleFinalizedFilter()}resetEmptyFilters(){document.getElementById("emptyProgramSearch").value="",document.getElementById("emptyTypeFilter").value="",document.getElementById("emptyInitiativeFilter").value="",this.handleEmptyFilter()}updateCounters(){setTimeout(()=>{const e=document.querySelectorAll('#draftProgramsTable tbody tr:not([style*="display: none"])'),t=document.querySelectorAll('#finalizedProgramsTable tbody tr:not([style*="display: none"])'),i=document.querySelectorAll('#emptyProgramsTable tbody tr:not([style*="display: none"])'),n=Array.from(e).filter(d=>!d.querySelector("td[colspan]")).length,r=Array.from(t).filter(d=>!d.querySelector("td[colspan]")).length,a=Array.from(i).filter(d=>!d.querySelector("td[colspan]")).length,l=document.getElementById("draft-count"),o=document.getElementById("finalized-count"),s=document.getElementById("empty-count");l&&(l.textContent=n),o&&(o.textContent=r),s&&(s.textContent=a)},50)}capitalizeFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}}function u(c,e){let t;return function(...n){const r=()=>{clearTimeout(t),c(...n)};clearTimeout(t),t=setTimeout(r,e)}}class f{constructor(){this.logic=new m,this.dom=new y,this.filters=new g,this.init()}init(){document.addEventListener("DOMContentLoaded",()=>{console.log("ðŸš€ Initializing View Programs module..."),this.dom.init(),this.filters.init(),this.setupGlobalEvents(),console.log("âœ… View Programs module initialized successfully")})}setupGlobalEvents(){window.addEventListener("error",e=>{console.error("ðŸ’¥ View Programs error:",e.error)}),window.addEventListener("resize",()=>{this.dom.handleResize()})}}new f;
