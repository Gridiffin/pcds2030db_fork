import"../assets/bootstrap_modal_fix-BR8foNQt.js";/* empty css                            */class i{constructor(t="#recentReportsContainer"){this.container=document.querySelector(t),this.searchInput=document.querySelector("#reportSearch"),this.clearSearchBtn=document.querySelector("#clearSearch"),this.currentPage=1,this.perPage=10,this.currentSearch="",this.loading=!1,this.config={apiUrl:this.getAppUrl()+"/app/views/admin/ajax/recent_reports_paginated.php",deleteApiUrl:this.getDeleteApiUrl(),debounceDelay:300,loadingClass:"loading-reports"},this.init()}getAppUrl(){return typeof window.ReportGeneratorConfig<"u"&&window.ReportGeneratorConfig.appUrl?window.ReportGeneratorConfig.appUrl:typeof window.APP_URL<"u"?window.APP_URL:window.location.origin+"/pcds2030_dashboard"}getDeleteApiUrl(){return typeof window.ReportGeneratorConfig<"u"&&window.ReportGeneratorConfig.apiEndpoints&&window.ReportGeneratorConfig.apiEndpoints.deleteReport?window.ReportGeneratorConfig.apiEndpoints.deleteReport:this.getAppUrl()+"/app/api/delete_report.php"}init(){this.setupEventListeners(),this.loadPage(1)}setupEventListeners(){if(this.searchInput){let t;this.searchInput.addEventListener("input",e=>{clearTimeout(t),t=setTimeout(()=>{this.handleSearch(e.target.value)},this.config.debounceDelay)})}this.clearSearchBtn&&this.clearSearchBtn.addEventListener("click",()=>{this.clearSearch()}),window.clearSearchAndReload=()=>{this.clearSearch()},window.addEventListener("reportGenerated",()=>{this.refresh()})}async loadPage(t,e=null,a=null){if(!this.loading){this.loading=!0,this.showLoading();try{this.currentPage=t,e!==null&&(this.perPage=e),a!==null&&(this.currentSearch=a);const r=new URLSearchParams({page:this.currentPage,per_page:this.perPage,search:this.currentSearch,format:"html"}),s=await fetch(`${this.config.apiUrl}?${r}`);if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const n=await s.text();this.container.innerHTML=n,this.setupPaginationListeners(),this.setupDeleteButtons(),this.updateSearchUI(),this.updateURL()}catch(r){console.error("Error loading reports page:",r),this.showError("Failed to load reports. Please try again.")}finally{this.loading=!1,this.hideLoading()}}}setupPaginationListeners(){this.container.querySelectorAll(".page-link[data-page]").forEach(r=>{r.disabled||r.addEventListener("click",s=>{s.preventDefault();const n=parseInt(r.dataset.page);n&&n!==this.currentPage&&this.loadPage(n)})});const e=this.container.querySelector("#pageSizeSelect");e&&e.addEventListener("change",r=>{const s=parseInt(r.target.value);this.loadPage(1,s)});const a=this.container.querySelector("#generateReportToggleEmpty");a&&typeof window.setupGenerateReportToggle=="function"&&a.addEventListener("click",()=>{const r=document.querySelector("#generateReportToggle");r&&r.click()})}setupDeleteButtons(){this.container.querySelectorAll(".delete-report-btn").forEach(e=>{e.addEventListener("click",a=>{const r=e.dataset.reportId,s=e.dataset.reportName;if(console.log("Delete button clicked:",{reportId:r,reportName:s,button:e}),console.log("All button datasets:",e.dataset),!r||r==="undefined"){console.error("Invalid report ID detected:",r),this.showMessage("Invalid report ID. Please refresh the page and try again.","error");return}const n=document.querySelector("#deleteReportModal");if(n){const l=n.querySelector("#reportNameToDelete"),o=n.querySelector("#confirmDeleteBtn");if(l&&(l.textContent=s),o){const c=o.cloneNode(!0);o.parentNode.replaceChild(c,o),c.addEventListener("click",()=>{this.handleDeleteReport(r)})}}})})}async handleDeleteReport(t){if(console.log("handleDeleteReport called with reportId:",t),!t||t==="undefined"||t===""){console.error("Invalid report ID provided to handleDeleteReport:",t),this.showMessage("Invalid report ID. Please refresh the page and try again.","error");return}try{const e={report_id:parseInt(t)};console.log("Sending delete request with data:",e);const a=await fetch(this.config.deleteApiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(console.log("Delete API response status:",a.status),!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const r=await a.json();if(console.log("Delete API response data:",r),r.success){const s=bootstrap.Modal.getInstance(document.querySelector("#deleteReportModal"));s&&s.hide(),this.showMessage("Report deleted successfully.","success"),this.refresh()}else throw new Error(r.error||r.message||"Failed to delete report")}catch(e){console.error("Error deleting report:",e),this.showMessage(`Failed to delete report: ${e.message}`,"error")}}handleSearch(t){const e=t.trim();e!==this.currentSearch&&this.loadPage(1,null,e)}clearSearch(){this.searchInput&&(this.searchInput.value=""),this.loadPage(1,null,"")}updateSearchUI(){if(this.searchInput&&this.clearSearchBtn){const t=this.currentSearch.length>0;this.clearSearchBtn.style.display=t?"block":"none",this.searchInput.value!==this.currentSearch&&(this.searchInput.value=this.currentSearch)}}updateURL(){const t=new URL(window.location),e=t.searchParams;this.currentPage>1?e.set("page",this.currentPage):e.delete("page"),this.perPage!==10?e.set("per_page",this.perPage):e.delete("per_page"),this.currentSearch?e.set("search",this.currentSearch):e.delete("search"),window.history.replaceState({},"",t.toString())}showLoading(){if(this.container&&(this.container.classList.add(this.config.loadingClass),!this.container.querySelector(".loading-overlay"))){const t=document.createElement("div");t.className="loading-overlay",t.innerHTML=`
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Loading reports...</span>
                    </div>
                `,this.container.appendChild(t)}}hideLoading(){if(this.container){this.container.classList.remove(this.config.loadingClass);const t=this.container.querySelector(".loading-overlay");t&&t.remove()}}showError(t){const e=`
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${t}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;this.container&&(this.container.innerHTML=e)}showMessage(t,e="info"){const a=`
            <div class="toast align-items-center text-white bg-${e==="success"?"success":"danger"} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${e==="success"?"check-circle":"exclamation-triangle"} me-2"></i>
                        ${t}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;let r=document.querySelector(".toast-container");r||(r=document.createElement("div"),r.className="toast-container position-fixed top-0 end-0 p-3",r.style.zIndex="1055",document.body.appendChild(r));const s=document.createElement("div");s.innerHTML=a;const n=s.firstElementChild;r.appendChild(n),new bootstrap.Toast(n,{delay:4e3}).show(),n.addEventListener("hidden.bs.toast",()=>{n.remove()})}refresh(){this.loadPage(this.currentPage,this.perPage,this.currentSearch)}static initFromURL(){const e=new URL(window.location).searchParams,a=new i,r=parseInt(e.get("page"))||1,s=parseInt(e.get("per_page"))||10,n=e.get("search")||"";return n&&a.searchInput&&(a.searchInput.value=n),a.loadPage(r,s,n),a}}document.addEventListener("DOMContentLoaded",function(){document.querySelector("#recentReportsContainer")&&(window.reportsPagination=i.initFromURL())});window.ReportsPagination=i;console.log("Admin reports bundle loaded");
