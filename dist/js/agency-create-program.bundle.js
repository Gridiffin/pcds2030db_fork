/* empty css                         */const p=/^[a-zA-Z0-9.]+$/,E=20;function x(e,t){return!e||typeof e!="string"?{isValid:!1,message:"Program number is required"}:!t||typeof t!="string"?{isValid:!1,message:"Initiative number is required for validation"}:p.test(e)?e.startsWith(t+".")?new RegExp("^"+t.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")+"\\.[a-zA-Z0-9]+$").test(e)?e.length>E?{isValid:!1,message:"Program number is too long (max 20 characters)"}:{isValid:!0,message:`Valid program number format (${t}.suffix)`}:{isValid:!1,message:"Please add a suffix after the initiative number (e.g., 1, A, 2B)"}:{isValid:!1,message:`Program number must start with "${t}."`}:{isValid:!1,message:"Invalid format. Use only letters, numbers, and dots."}}async function S(e,t){try{const i=`${window.APP_URL||""}/app/ajax/agency/check_program_number.php`;return(await(await fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({initiative_id:t,program_number:e})})).json()).exists===!0}catch(n){throw console.error("Error checking program number:",n),new Error("Failed to check program number")}}function w(e,t,n){const i=e.value,a=document.getElementById("number-help-text"),s=document.getElementById("final-number-display"),d=document.getElementById("final-number-preview"),u=document.getElementById("number-validation");if(i){const r=n[i];t.disabled=!1,t.placeholder=`e.g., ${r}.1 or ${r}.A`,a.textContent=`Program number must start with "${r}." (e.g., ${r}.1, ${r}.A)`,s.style.display="block",d.textContent="Will be generated automatically"}else t.disabled=!0,t.placeholder="Select initiative first",a.textContent="Select an initiative to enable program numbering",s.style.display="none";u.style.display="none",t.classList.remove("is-valid","is-invalid")}function I(){const e=document.getElementById("initiative_id"),t=document.getElementById("program_number");if(!e||!t){console.warn("Create program elements not found");return}const n=window.initiativeData||[],i={};n.forEach(a=>{i[a.initiative_id]=a.initiative_number}),e.addEventListener("change",()=>{w(e,t,i)}),t.addEventListener("input",async()=>{const a=t.value.trim(),s=document.getElementById("number-validation"),d=document.getElementById("validation-message"),u=document.getElementById("final-number-preview"),r=e.value;if(!r||!a){s.style.display="none",t.classList.remove("is-valid","is-invalid"),u.textContent="Will be generated automatically";return}const h=i[r],o=x(a,h);if(o.isValid)try{await S(a,r)&&(o.isValid=!1,o.message="Duplicate program number. This number is already in use for the selected initiative.")}catch{o.isValid=!1,o.message="Error checking program number. Please try again."}s.style.display="block",d.className=o.isValid?"text-success":"text-danger",d.textContent=o.message,t.classList.remove("is-valid","is-invalid"),t.classList.add(o.isValid?"is-valid":"is-invalid"),u.textContent=a||"Will be generated automatically"})}const k=/^\d{4}-\d{2}-\d{2}$/;function m(e){if(!e)return!0;if(!k.test(e))return!1;const t=new Date(e+"T00:00:00"),[n,i,a]=e.split("-").map(Number);return t.getFullYear()===n&&t.getMonth()===i-1&&t.getDate()===a}function g(e,t){return!e||!t?!0:new Date(e)<=new Date(t)}function v(e){return!e||typeof e!="string"||!e.trim()?{isValid:!1,message:"Program name is required"}:e.length>255?{isValid:!1,message:"Program name is too long (max 255 characters)"}:{isValid:!0,message:""}}function l(e,t){e.classList.add("is-invalid"),e.classList.remove("is-valid");let n=e.nextElementSibling;(!n||!n.classList.contains("invalid-feedback"))&&(n=document.createElement("div"),n.className="invalid-feedback",e.parentNode.insertBefore(n,e.nextSibling)),n.textContent=t}function c(e){e.classList.remove("is-invalid","is-valid");const t=e.nextElementSibling;t&&t.classList.contains("invalid-feedback")&&(t.textContent="")}function P(e){let t=!0;const n=e.querySelector("#program_name"),i=v(n.value);i.isValid?c(n):(l(n,i.message),t=!1);const a=e.querySelector("#start_date"),s=e.querySelector("#end_date");return a.value&&!m(a.value)?(l(a,"Invalid date format. Use YYYY-MM-DD"),t=!1):c(a),s.value&&!m(s.value)?(l(s,"Invalid date format. Use YYYY-MM-DD"),t=!1):c(s),a.value&&s.value&&!g(a.value,s.value)&&(l(s,"End date must be after start date"),t=!1),t}function D(){const e=document.getElementById("createProgramForm");if(!e){console.warn("Create program form not found");return}e.addEventListener("submit",a=>{if(!P(e)){a.preventDefault();const s=e.querySelector(".is-invalid");s&&s.scrollIntoView({behavior:"smooth",block:"center"})}});const t=e.querySelector("#program_name");t&&t.addEventListener("input",()=>{const a=v(t.value);a.isValid?c(t):l(t,a.message)});const n=e.querySelector("#start_date"),i=e.querySelector("#end_date");n&&i&&[n,i].forEach(a=>{a.addEventListener("change",()=>{n.value&&i.value&&(g(n.value,i.value)?c(i):l(i,"End date must be after start date"))})})}function V(){document.querySelectorAll('input[name="assigned_editors[]"]').forEach(t=>t.checked=!0)}function y(){document.querySelectorAll('input[name="assigned_editors[]"]').forEach(t=>t.checked=!1)}function f(e){const t=document.getElementById("userSelectionSection");t&&(t.style.display=e?"block":"none",e||y())}function _(){const e=document.getElementById("restrict_editors");if(!e||!e.checked)return!0;if(document.querySelectorAll('input[name="assigned_editors[]"]:checked').length===0){const n=document.createElement("div");n.className="alert alert-danger mt-3",n.innerHTML='<i class="fas fa-exclamation-circle me-2"></i>Please select at least one user when restricting editors.';const i=document.getElementById("userSelectionSection");if(!i)return console.warn("User selection section not found in DOM"),!1;const a=i.querySelector(".alert-danger");return a&&a.remove(),i.appendChild(n),!1}return!0}function L(){const e=document.getElementById("restrict_editors");if(!e){console.warn("User permissions elements not found");return}e.addEventListener("change",()=>{f(e.checked);const i=document.getElementById("userSelectionSection")?.querySelector(".alert-danger");i&&i.remove()}),document.addEventListener("click",n=>{n.target.matches('[data-action="select-all-users"]')?V():n.target.matches('[data-action="select-no-users"]')&&y()});const t=document.getElementById("createProgramForm");t&&t.addEventListener("submit",n=>{if(!_()){n.preventDefault();const i=document.getElementById("userSelectionSection");i&&(typeof i.scrollIntoView=="function"?i.scrollIntoView({behavior:"smooth",block:"center"}):i.focus())}}),f(e.checked)}document.addEventListener("DOMContentLoaded",()=>{I(),D(),L()});
