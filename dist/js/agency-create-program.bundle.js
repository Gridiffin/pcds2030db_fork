const p=/^[a-zA-Z0-9.]+$/;function E(e,t){return!e||typeof e!="string"?{isValid:!1,message:"Program number is required"}:!t||typeof t!="string"?{isValid:!1,message:"Initiative number is required for validation"}:p.test(e)?e.startsWith(t+".")?new RegExp("^"+t.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")+"\\.[a-zA-Z0-9]+$").test(e)?e.length>20?{isValid:!1,message:"Program number is too long (max 20 characters)"}:{isValid:!0,message:`Valid program number format (${t}.suffix)`}:{isValid:!1,message:"Please add a suffix after the initiative number (e.g., 1, A, 2B)"}:{isValid:!1,message:`Program number must start with "${t}."`}:{isValid:!1,message:"Invalid format. Use only letters, numbers, and dots."}}async function x(e,t){try{const a=`${window.APP_URL||""}/app/ajax/agency/check_program_number.php`;return(await(await fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({initiative_id:t,program_number:e})})).json()).exists===!0}catch(n){throw console.error("Error checking program number:",n),new Error("Failed to check program number")}}function S(e,t,n){const a=e.value,i=document.getElementById("number-help-text"),s=document.getElementById("final-number-display"),d=document.getElementById("final-number-preview"),u=document.getElementById("number-validation");if(a){const r=n[a];t.disabled=!1,t.placeholder=`e.g., ${r}.1 or ${r}.A`,i.textContent=`Program number must start with "${r}." (e.g., ${r}.1, ${r}.A)`,s.style.display="block",d.textContent="Will be generated automatically"}else t.disabled=!0,t.placeholder="Select initiative first",i.textContent="Select an initiative to enable program numbering",s.style.display="none";u.style.display="none",t.classList.remove("is-valid","is-invalid")}function w(){const e=document.getElementById("initiative_id"),t=document.getElementById("program_number");if(!e||!t){console.warn("Create program elements not found");return}const n=window.initiativeData||[],a={};n.forEach(i=>{a[i.initiative_id]=i.initiative_number}),e.addEventListener("change",()=>{S(e,t,a)}),t.addEventListener("input",async()=>{const i=t.value.trim(),s=document.getElementById("number-validation"),d=document.getElementById("validation-message"),u=document.getElementById("final-number-preview"),r=e.value;if(!r||!i){s.style.display="none",t.classList.remove("is-valid","is-invalid"),u.textContent="Will be generated automatically";return}const h=a[r],o=E(i,h);if(o.isValid)try{await x(i,r)&&(o.isValid=!1,o.message="Duplicate program number. This number is already in use for the selected initiative.")}catch{o.isValid=!1,o.message="Error checking program number. Please try again."}s.style.display="block",d.className=o.isValid?"text-success":"text-danger",d.textContent=o.message,t.classList.remove("is-valid","is-invalid"),t.classList.add(o.isValid?"is-valid":"is-invalid"),u.textContent=i||"Will be generated automatically"})}const I=/^\d{4}-\d{2}-\d{2}$/;function m(e){if(!e)return!0;if(!I.test(e))return!1;const t=new Date(e+"T00:00:00"),[n,a,i]=e.split("-").map(Number);return t.getFullYear()===n&&t.getMonth()===a-1&&t.getDate()===i}function g(e,t){return!e||!t?!0:new Date(e)<=new Date(t)}function v(e){return!e||typeof e!="string"||!e.trim()?{isValid:!1,message:"Program name is required"}:e.length>255?{isValid:!1,message:"Program name is too long (max 255 characters)"}:{isValid:!0,message:""}}function l(e,t){e.classList.add("is-invalid"),e.classList.remove("is-valid");let n=e.nextElementSibling;(!n||!n.classList.contains("invalid-feedback"))&&(n=document.createElement("div"),n.className="invalid-feedback",e.parentNode.insertBefore(n,e.nextSibling)),n.textContent=t}function c(e){e.classList.remove("is-invalid","is-valid");const t=e.nextElementSibling;t&&t.classList.contains("invalid-feedback")&&(t.textContent="")}function _(e){let t=!0;const n=e.querySelector("#program_name"),a=v(n.value);a.isValid?c(n):(l(n,a.message),t=!1);const i=e.querySelector("#start_date"),s=e.querySelector("#end_date");return i.value&&!m(i.value)?(l(i,"Invalid date format. Use YYYY-MM-DD"),t=!1):c(i),s.value&&!m(s.value)?(l(s,"Invalid date format. Use YYYY-MM-DD"),t=!1):c(s),i.value&&s.value&&!g(i.value,s.value)&&(l(s,"End date must be after start date"),t=!1),t}function k(){const e=document.getElementById("createProgramForm");if(!e){console.warn("Create program form not found");return}e.addEventListener("submit",i=>{if(!_(e)){i.preventDefault();const s=e.querySelector(".is-invalid");s&&s.scrollIntoView({behavior:"smooth",block:"center"})}});const t=e.querySelector("#program_name");t&&t.addEventListener("input",()=>{const i=v(t.value);i.isValid?c(t):l(t,i.message)});const n=e.querySelector("#start_date"),a=e.querySelector("#end_date");n&&a&&[n,a].forEach(i=>{i.addEventListener("change",()=>{n.value&&a.value&&(g(n.value,a.value)?c(a):l(a,"End date must be after start date"))})})}function P(){document.querySelectorAll('input[name="assigned_editors[]"]').forEach(t=>t.checked=!0)}function y(){document.querySelectorAll('input[name="assigned_editors[]"]').forEach(t=>t.checked=!1)}function f(e){const t=document.getElementById("userSelectionSection");t&&(t.style.display=e?"block":"none",e||y())}function D(){const e=document.getElementById("restrict_editors");if(!e||!e.checked)return!0;if(document.querySelectorAll('input[name="assigned_editors[]"]:checked').length===0){const n=document.createElement("div");n.className="alert alert-danger mt-3",n.innerHTML='<i class="fas fa-exclamation-circle me-2"></i>Please select at least one user when restricting editors.';const a=document.getElementById("userSelectionSection");if(!a)return console.warn("User selection section not found in DOM"),!1;const i=a.querySelector(".alert-danger");return i&&i.remove(),a.appendChild(n),!1}return!0}function V(){const e=document.getElementById("restrict_editors");if(!e){console.warn("User permissions elements not found");return}e.addEventListener("change",()=>{f(e.checked);const a=document.getElementById("userSelectionSection")?.querySelector(".alert-danger");a&&a.remove()}),document.addEventListener("click",n=>{n.target.matches('[data-action="select-all-users"]')?P():n.target.matches('[data-action="select-no-users"]')&&y()});const t=document.getElementById("createProgramForm");t&&t.addEventListener("submit",n=>{if(!D()){n.preventDefault();const a=document.getElementById("userSelectionSection");a&&(typeof a.scrollIntoView=="function"?a.scrollIntoView({behavior:"smooth",block:"center"}):a.focus())}}),f(e.checked)}document.addEventListener("DOMContentLoaded",()=>{w(),k(),V()});
