class u{constructor(){this.chart=null,this.chartData=null,this.init()}init(){if(this.chartData=window.programRatingChartData||null,!this.chartData){console.warn("‚ö†Ô∏è No chart data found");return}this.createChart()}createChart(){const t=document.getElementById("programRatingChart");if(!t){console.error("‚ùå Chart canvas not found");return}if(typeof Chart>"u"){console.error("‚ùå Chart.js not loaded");return}this.chart&&this.chart.destroy();try{this.chart=new Chart(t,{type:"doughnut",data:{labels:this.chartData.labels,datasets:[{data:this.chartData.data,backgroundColor:["#ffc107","#dc3545","#28a745","#6c757d"],borderWidth:2,borderColor:"#ffffff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom",labels:{padding:20,usePointStyle:!0,font:{size:12}}},tooltip:{callbacks:{label:function(e){const a=e.label||"",s=e.raw||0,r=e.dataset.data.reduce((i,n)=>i+n,0),o=r>0?Math.round(s/r*100):0;return`${a}: ${s} (${o}%)`}}}},cutout:"70%",animation:{animateRotate:!0,animateScale:!0,duration:1e3}}}),window.programRatingChart=this.chart}catch(e){console.error("‚ùå Error creating chart:",e),this.showChartError()}}showChartError(){const t=document.getElementById("programRatingChart");if(t){const e=t.parentElement;e.innerHTML=`
                <div class="chart-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading chart</p>
                </div>
            `}}showLoading(){const t=document.getElementById("programRatingChart");if(t){const e=t.parentElement;e.innerHTML=`
                <div class="chart-loading">
                    <i class="fas fa-spinner"></i>
                    Loading chart...
                </div>
            `}}update(t){this.chart&&t&&(this.chart.data.datasets[0].data=t.data,this.chart.data.labels=t.labels,this.chart.update("active"))}refresh(){this.createChart()}destroy(){this.chart&&(this.chart.destroy(),this.chart=null)}}class g{constructor(){this.init()}init(){this.setupEventListeners(),this.initializeToggles()}setupEventListeners(){this.setupRefreshButton(),this.setupAssignedToggle(),this.setupCardInteractions()}setupRefreshButton(){const t=document.getElementById("refreshDashboard");t&&t.addEventListener("click",a=>{a.preventDefault(),this.handleRefresh(t)});const e=document.getElementById("refreshPage");e&&e.addEventListener("click",a=>{a.preventDefault(),this.handleRefresh(e)})}handleRefresh(t){t.classList.add("loading"),t.querySelector("i")?.className,t.querySelector("span")?.innerText,t.innerHTML='<i class="fas fa-sync-alt fa-spin"></i> <span>Refreshing...</span>',t.disabled=!0,setTimeout(()=>{window.location.reload()},500)}setupAssignedToggle(){const t=document.getElementById("includeAssignedToggle");if(!t)return;const e=localStorage.getItem("includeAssignedPrograms");e!==null?t.checked=e==="true":t.checked=!1,t.addEventListener("change",a=>{this.handleAssignedToggle(a.target.checked)})}handleAssignedToggle(t){localStorage.setItem("includeAssignedPrograms",t.toString()),this.refreshDashboardData(t),console.log(`üîÑ Assigned programs toggle: ${t?"ON":"OFF"}`)}refreshDashboardData(t){this.showLoadingState();const e=window.currentPeriodId||null;fetch("ajax/agency_dashboard_data.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period_id:e,include_assigned:t})}).then(a=>a.json()).then(a=>{a.success?this.updateDashboardWithData(a):(console.error("‚ùå Dashboard data refresh failed:",a.error),this.showErrorState())}).catch(a=>{console.error("‚ùå AJAX error:",a),this.showErrorState()}).finally(()=>{this.hideLoadingState()})}updateDashboardWithData(t){t.stats&&this.updateStatsCards(t.stats),t.chart_data&&window.AgencyDashboard?.chart&&window.AgencyDashboard.chart.update(t.chart_data),t.recent_updates&&window.AgencyDashboard?.programsTable&&window.AgencyDashboard.programsTable.updateTable(t.recent_updates),console.log("‚úÖ Dashboard updated with new data")}updateStatsCards(t){const e=document.querySelector(".bento-card.primary .display-4");e&&(e.textContent=t.total||0);const a=document.querySelector(".bento-card.success .display-4");a&&(a.textContent=t["on-track"]||0);const s=document.querySelector(".bento-card.warning .display-4");s&&(s.textContent=t.delayed||0);const r=document.querySelector(".bento-card.info .display-4");r&&(r.textContent=t.completed||0);const o=t.total||0;if(o>0){const i=Math.round((t["on-track"]||0)/o*100),n=Math.round((t.delayed||0)/o*100),c=Math.round((t.completed||0)/o*100),l=document.querySelectorAll(".opacity-75");l[0]&&(l[0].textContent=`${i}% of total`),l[1]&&(l[1].textContent=`${n}% of total`),l[2]&&(l[2].textContent=`${c}% of total`)}}setupCardInteractions(){document.querySelectorAll(".bento-card").forEach(t=>{t.addEventListener("mouseenter",()=>{t.style.transform="translateY(-4px)"}),t.addEventListener("mouseleave",()=>{t.style.transform="translateY(0)"})})}showLoadingState(){document.querySelectorAll(".bento-card .display-4").forEach(t=>{t.style.opacity="0.5"})}hideLoadingState(){document.querySelectorAll(".bento-card .display-4").forEach(t=>{t.style.opacity="1"})}showErrorState(){console.error("‚ùå Failed to refresh dashboard data")}initializeToggles(){console.log("üîß Dashboard controls initialized")}refresh(){const t=document.getElementById("includeAssignedToggle"),e=t?t.checked:!1;this.refreshDashboardData(e)}}class f{constructor(){this.currentSlide=0,this.totalSlides=0,this.autoplayInterval=null,this.autoplayDelay=8e3,this.init()}init(){this.setupCarousel(),this.setupEventListeners(),this.startAutoplay()}setupCarousel(){const t=document.getElementById("initiativeCarouselInner");if(!t)return;const e=t.querySelectorAll(".carousel-item");if(this.totalSlides=e.length,this.totalSlides===0){console.warn("‚ö†Ô∏è No initiative carousel slides found");return}this.setupIndicators(),this.showSlide(0),console.log(`üé† Initiative carousel initialized with ${this.totalSlides} slides`)}setupIndicators(){const t=document.getElementById("carouselIndicators");if(t){t.innerHTML="";for(let e=0;e<this.totalSlides;e++){const a=document.createElement("button");a.setAttribute("aria-label",`Slide ${e+1}`),a.addEventListener("click",()=>this.goToSlide(e)),e===0&&a.classList.add("active"),t.appendChild(a)}}}setupEventListeners(){const t=document.getElementById("carouselPrevBtn");t&&t.addEventListener("click",()=>this.previousSlide());const e=document.getElementById("carouselNextBtn");e&&e.addEventListener("click",()=>this.nextSlide());const a=document.getElementById("programCarouselCard");a&&(a.addEventListener("mouseenter",()=>this.pauseAutoplay()),a.addEventListener("mouseleave",()=>this.startAutoplay())),document.addEventListener("keydown",s=>{this.isCarouselInView()&&(s.key==="ArrowLeft"?(s.preventDefault(),this.previousSlide()):s.key==="ArrowRight"&&(s.preventDefault(),this.nextSlide()))})}showSlide(t){const e=document.getElementById("initiativeCarouselInner");if(!e)return;const a=e.querySelectorAll(".carousel-item"),s=document.querySelectorAll("#carouselIndicators button");a.forEach(r=>r.classList.remove("active")),a[t]&&a[t].classList.add("active"),s.forEach((r,o)=>{r.classList.toggle("active",o===t)}),this.currentSlide=t}nextSlide(){const t=(this.currentSlide+1)%this.totalSlides;this.goToSlide(t)}previousSlide(){const t=(this.currentSlide-1+this.totalSlides)%this.totalSlides;this.goToSlide(t)}goToSlide(t){t>=0&&t<this.totalSlides&&(this.showSlide(t),this.restartAutoplay())}startAutoplay(){this.totalSlides<=1||(this.pauseAutoplay(),this.autoplayInterval=setInterval(()=>{this.nextSlide()},this.autoplayDelay))}pauseAutoplay(){this.autoplayInterval&&(clearInterval(this.autoplayInterval),this.autoplayInterval=null)}restartAutoplay(){this.startAutoplay()}isCarouselInView(){const t=document.getElementById("programCarouselCard");if(!t)return!1;const e=t.getBoundingClientRect();return e.top>=0&&e.bottom<=window.innerHeight}refresh(){this.pauseAutoplay(),this.currentSlide=0,this.setupCarousel(),this.startAutoplay()}destroy(){this.pauseAutoplay()}}class p{constructor(){this.sortColumn=null,this.sortDirection="asc",this.init()}init(){this.setupTableSorting(),this.setupTableInteractions()}setupTableSorting(){const t=document.querySelectorAll(".table th.sortable");t.forEach(e=>{e.addEventListener("click",()=>{const a=e.getAttribute("data-sort");this.sortTable(a)})}),t.length>0&&console.log("üìä Table sorting initialized")}sortTable(t){const e=document.getElementById("dashboardProgramsTable");if(!e)return;const a=Array.from(e.querySelectorAll("tr"));this.sortColumn===t?this.sortDirection=this.sortDirection==="asc"?"desc":"asc":(this.sortDirection="asc",this.sortColumn=t),a.sort((s,r)=>{const o=this.getCellValue(s,t),i=this.getCellValue(r,t);let n=0;if(t==="date"){const c=new Date(o),l=new Date(i);n=c-l}else if(t==="rating"){const c={delayed:1,"severe-delay":2,"not-started":3,"on-track-yearly":4,"on-track":5,"target-achieved":6,completed:7},l=c[o.toLowerCase()]||999,h=c[i.toLowerCase()]||999;n=l-h}else n=o.localeCompare(i);return this.sortDirection==="asc"?n:-n}),a.forEach(s=>e.appendChild(s)),this.updateSortIndicators(t),console.log(`üìä Table sorted by ${t} (${this.sortDirection})`)}getCellValue(t,e){switch(e){case"name":const a=t.querySelector("td:first-child .fw-medium");return a?a.textContent.trim():"";case"rating":const s=t.querySelector("td:nth-child(2) .badge");return s?s.textContent.trim():"";case"date":const r=t.querySelector("td:nth-child(3)");return r?r.textContent.trim():"";default:return""}}updateSortIndicators(t){document.querySelectorAll(".table th.sortable").forEach(a=>{const s=a.querySelector("i");a.getAttribute("data-sort")===t?(s.className=this.sortDirection==="asc"?"fas fa-sort-up ms-1":"fas fa-sort-down ms-1",a.classList.add("sorted")):(s.className="fas fa-sort ms-1",a.classList.remove("sorted"))})}setupTableInteractions(){const t=document.getElementById("dashboardProgramsTable");t&&(t.addEventListener("click",e=>{const a=e.target.closest("tr");a&&a.dataset.programId&&console.log("Program row clicked:",a.dataset.programId)}),t.setAttribute("tabindex","0"),t.addEventListener("keydown",e=>{if(e.key==="Enter"||e.key===" "){const a=t.querySelector("tr:focus");a&&a.click()}}))}updateTable(t){const e=document.getElementById("dashboardProgramsTable"),a=document.getElementById("programCount");!e||!t||(a&&(a.textContent=t.length),e.innerHTML="",t.forEach(s=>{const r=this.createProgramRow(s);e.appendChild(r)}),console.log("üìä Programs table updated with new data"))}createProgramRow(t){const e=document.createElement("tr"),a=t.is_assigned&&t.is_assigned?"assigned":"created",s=a==="assigned"?"Assigned":"Agency-Created",r=t.is_draft&&t.is_draft==1,o=a==="assigned"&&!t.rating;e.setAttribute("data-program-type",a),(r||o)&&e.classList.add("draft-program");const i=t.rating||"not-started";let n="secondary";switch(i){case"on-track":case"on-track-yearly":n="warning";break;case"delayed":case"severe-delay":n="danger";break;case"completed":case"target-achieved":n="success";break}const c=t.updated_at?new Date(t.updated_at).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"N/A";return e.innerHTML=`
            <td>
                <div class="fw-medium">
                    ${this.escapeHtml(t.program_name)}
                    ${r||o?'<span class="badge bg-secondary ms-1">Draft</span>':""}
                </div>
                <div class="small text-muted program-type-indicator">
                    <i class="fas fa-${a==="assigned"?"tasks":"folder-plus"} me-1"></i>
                    ${s}
                </div>
            </td>
            <td>
                <span class="badge bg-${n}">
                    ${this.formatRating(i)}
                </span>
            </td>
            <td>${c}</td>
        `,e}formatRating(t){return t.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}refresh(){this.sortColumn&&this.sortTable(this.sortColumn)}}class m{constructor(){this.chart=null,this.logic=null,this.carousel=null,this.programsTable=null,this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.initializeComponents()):this.initializeComponents()}initializeComponents(){try{this.chart=new u,this.logic=new g,this.carousel=new f,this.programsTable=new p,console.log("‚úÖ Agency Dashboard initialized successfully")}catch(t){console.error("‚ùå Error initializing Agency Dashboard:",t)}}refresh(){this.chart&&this.chart.refresh(),this.logic&&this.logic.refresh(),this.carousel&&this.carousel.refresh(),this.programsTable&&this.programsTable.refresh()}}const y=new m;window.AgencyDashboard=y;
