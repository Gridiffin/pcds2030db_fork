const E=/^[a-zA-Z0-9.]+$/;function p(e,t){return e?E.test(e)?e.startsWith(t+".")?new RegExp("^"+t.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")+"\\.[a-zA-Z0-9]+$").test(e)?e.length>20?{isValid:!1,message:"Program number is too long (max 20 characters)"}:{isValid:!0,message:`Valid program number format (${t}.suffix)`}:{isValid:!1,message:"Please add a suffix after the initiative number (e.g., 1, A, 2B)"}:{isValid:!1,message:`Program number must start with "${t}."`}:{isValid:!1,message:"Invalid format. Use only letters, numbers, and dots."}:{isValid:!1,message:"Program number is required"}}async function x(e,t){try{return(await(await fetch(`${window.APP_URL}/app/ajax/agency/check_program_number.php`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({initiative_id:t,program_number:e})})).json()).exists}catch(n){throw console.error("Error checking program number:",n),new Error("Failed to check program number")}}function S(e,t,n){const i=e.value,a=document.getElementById("number-help-text"),r=document.getElementById("final-number-display"),d=document.getElementById("final-number-preview"),u=document.getElementById("number-validation");if(i){const s=n[i];t.disabled=!1,t.placeholder=`e.g., ${s}.1 or ${s}.A`,a.textContent=`Program number must start with "${s}." (e.g., ${s}.1, ${s}.A)`,r.style.display="block",d.textContent="Will be generated automatically"}else t.disabled=!0,t.placeholder="Select initiative first",a.textContent="Select an initiative to enable program numbering",r.style.display="none";u.style.display="none",t.classList.remove("is-valid","is-invalid")}function _(){const e=document.getElementById("initiative_id"),t=document.getElementById("program_number");if(!e||!t){console.warn("Create program elements not found");return}const n=window.initiativeData||[],i={};n.forEach(a=>{i[a.initiative_id]=a.initiative_number}),e.addEventListener("change",()=>{S(e,t,i)}),t.addEventListener("input",async()=>{const a=t.value.trim(),r=document.getElementById("number-validation"),d=document.getElementById("validation-message"),u=document.getElementById("final-number-preview"),s=e.value;if(!s||!a){r.style.display="none",t.classList.remove("is-valid","is-invalid"),u.textContent="Will be generated automatically";return}const y=i[s],o=p(a,y);if(o.isValid)try{await x(a,s)&&(o.isValid=!1,o.message="Duplicate program number. This number is already in use for the selected initiative.")}catch{o.isValid=!1,o.message="Error checking program number. Please try again."}r.style.display="block",d.className=o.isValid?"text-success":"text-danger",d.textContent=o.message,t.classList.remove("is-valid","is-invalid"),t.classList.add(o.isValid?"is-valid":"is-invalid"),u.textContent=a||"Will be generated automatically"})}const k=/^\d{4}-\d{2}-\d{2}$/;function m(e){return e?k.test(e):!0}function g(e,t){return!e||!t?!0:new Date(e)<=new Date(t)}function v(e){return e.trim()?e.length>255?{isValid:!1,message:"Program name is too long (max 255 characters)"}:{isValid:!0,message:""}:{isValid:!1,message:"Program name is required"}}function l(e,t){e.classList.add("is-invalid"),e.classList.remove("is-valid");let n=e.nextElementSibling;(!n||!n.classList.contains("invalid-feedback"))&&(n=document.createElement("div"),n.className="invalid-feedback",e.parentNode.insertBefore(n,e.nextSibling)),n.textContent=t}function c(e){e.classList.remove("is-invalid","is-valid");const t=e.nextElementSibling;t&&t.classList.contains("invalid-feedback")&&(t.textContent="")}function w(e){let t=!0;const n=e.querySelector("#program_name"),i=v(n.value);i.isValid?c(n):(l(n,i.message),t=!1);const a=e.querySelector("#start_date"),r=e.querySelector("#end_date");return a.value&&!m(a.value)?(l(a,"Invalid date format. Use YYYY-MM-DD"),t=!1):c(a),r.value&&!m(r.value)?(l(r,"Invalid date format. Use YYYY-MM-DD"),t=!1):c(r),a.value&&r.value&&!g(a.value,r.value)&&(l(r,"End date must be after start date"),t=!1),t}function P(){const e=document.getElementById("createProgramForm");if(!e){console.warn("Create program form not found");return}e.addEventListener("submit",a=>{if(!w(e)){a.preventDefault();const r=e.querySelector(".is-invalid");r&&r.scrollIntoView({behavior:"smooth",block:"center"})}});const t=e.querySelector("#program_name");t&&t.addEventListener("input",()=>{const a=v(t.value);a.isValid?c(t):l(t,a.message)});const n=e.querySelector("#start_date"),i=e.querySelector("#end_date");n&&i&&[n,i].forEach(a=>{a.addEventListener("change",()=>{n.value&&i.value&&(g(n.value,i.value)?c(i):l(i,"End date must be after start date"))})})}function I(){document.querySelectorAll('input[name="assigned_editors[]"]').forEach(t=>t.checked=!0)}function h(){document.querySelectorAll('input[name="assigned_editors[]"]').forEach(t=>t.checked=!1)}function f(e){const t=document.getElementById("userSelectionSection");t&&(t.style.display=e?"block":"none",e||h())}function L(){const e=document.getElementById("restrict_editors");if(!e||!e.checked)return!0;if(document.querySelectorAll('input[name="assigned_editors[]"]:checked').length===0){const n=document.createElement("div");n.className="alert alert-danger mt-3",n.innerHTML='<i class="fas fa-exclamation-circle me-2"></i>Please select at least one user when restricting editors.';const i=document.getElementById("userSelectionSection"),a=i.querySelector(".alert-danger");return a&&a.remove(),i.appendChild(n),!1}return!0}function V(){const e=document.getElementById("restrict_editors");if(!e){console.warn("User permissions elements not found");return}e.addEventListener("change",()=>{f(e.checked);const i=document.getElementById("userSelectionSection")?.querySelector(".alert-danger");i&&i.remove()}),document.addEventListener("click",n=>{n.target.matches('[data-action="select-all-users"]')?I():n.target.matches('[data-action="select-no-users"]')&&h()});const t=document.getElementById("createProgramForm");t&&t.addEventListener("submit",n=>{if(!L()){n.preventDefault();const i=document.getElementById("userSelectionSection");i&&i.scrollIntoView({behavior:"smooth",block:"center"})}}),f(e.checked)}document.addEventListener("DOMContentLoaded",()=>{_(),P(),V()});
