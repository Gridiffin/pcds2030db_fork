document.addEventListener("DOMContentLoaded",function(){if(_(),$(),N(),typeof TablePagination<"u")M();else{let m=0;const v=50,s=setInterval(()=>{m++,typeof TablePagination<"u"?(clearInterval(s),M()):m>=v&&(clearInterval(s),console.error("TablePagination not found after 5 seconds. Pagination will not be initialized."))},100)}["draftProgramsTable","finalizedProgramsTable"].forEach(m=>{const v=document.getElementById(m);if(!v)return;const s=v.querySelectorAll("th.sortable");s.forEach(g=>{g.style.cursor="pointer",g.addEventListener("click",function(){this.getAttribute("data-sort");const b=(this.getAttribute("data-direction")||"asc")==="asc"?"desc":"asc";s.forEach(u=>{const h=u.querySelector("i");u===this?h.className=b==="asc"?"fas fa-sort-up ms-1":"fas fa-sort-down ms-1":(h.className="fas fa-sort ms-1",u.removeAttribute("data-direction"))}),this.setAttribute("data-direction",b),window.tablePaginations[m]&&window.tablePaginations[m].refresh()})})});const n=document.getElementById("draftProgramSearch"),t=document.getElementById("draftRatingFilter"),i=document.getElementById("draftTypeFilter"),o=document.getElementById("draftInitiativeFilter"),l=document.getElementById("resetDraftFilters");n&&n.addEventListener("keyup",function(){p("draft")}),t&&t.addEventListener("change",function(){p("draft")}),i&&i.addEventListener("change",function(){p("draft")}),o&&o.addEventListener("change",function(){p("draft")}),l&&l.addEventListener("click",function(){n&&(n.value=""),t&&(t.value=""),i&&(i.value=""),o&&(o.value=""),p("draft")});const d=document.getElementById("finalizedProgramSearch"),c=document.getElementById("finalizedRatingFilter"),f=document.getElementById("finalizedTypeFilter"),r=document.getElementById("finalizedInitiativeFilter"),a=document.getElementById("resetFinalizedFilters");d&&d.addEventListener("keyup",function(){p("finalized")}),c&&c.addEventListener("change",function(){p("finalized")}),f&&f.addEventListener("change",function(){p("finalized")}),r&&r.addEventListener("change",function(){p("finalized")}),a&&a.addEventListener("click",function(){d&&(d.value=""),c&&(c.value=""),f&&(f.value=""),r&&(r.value=""),p("finalized")}),document.querySelectorAll(".submit-program").forEach(m=>{m.addEventListener("click",function(){const v=this.getAttribute("data-program-id");fetch("../ajax/submit_program.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`program_id=${v}`}).then(s=>s.json()).then(s=>{s.status==="success"?(showToast("Success",s.message,"success"),setTimeout(()=>location.reload(),1e3)):s.status==="info"?showToast("Info",s.message,"info"):showToast("Error",s.message,"danger")}).catch(s=>{console.error("Error:",s),showToast("Error","An error occurred while submitting the program.","danger")})})})});function p(e){const n=e==="draft"?"draftProgramsTable":"finalizedProgramsTable",t=e==="draft"?"draftFilterBadges":"finalizedFilterBadges",i=document.getElementById(e+"ProgramSearch"),o=document.getElementById(e+"RatingFilter"),l=document.getElementById(e+"TypeFilter"),d=document.getElementById(e+"InitiativeFilter"),c=i?i.value.toLowerCase():"",f=o?o.value:"",r=l?l.value:"",a=d?d.value:"",m=document.getElementById(t);if(m&&(m.innerHTML=""),c||f||r||a){let s='<span class="badge-label">Active filters:</span>';if(c&&(s+=`<span class="filter-badge">"${c}" <i class="fas fa-times remove-filter" data-filter="search" data-table="${e}"></i></span>`),f){const g=document.getElementById(e+"RatingFilter").options[document.getElementById(e+"RatingFilter").selectedIndex].text;s+=`<span class="filter-badge">${g} <i class="fas fa-times remove-filter" data-filter="rating" data-table="${e}"></i></span>`}if(r){const g=document.getElementById(e+"TypeFilter").options[document.getElementById(e+"TypeFilter").selectedIndex].text;s+=`<span class="filter-badge">${g} <i class="fas fa-times remove-filter" data-filter="type" data-table="${e}"></i></span>`}if(a){const g=document.getElementById(e+"InitiativeFilter").options[document.getElementById(e+"InitiativeFilter").selectedIndex].text;s+=`<span class="filter-badge">${g} <i class="fas fa-times remove-filter" data-filter="initiative" data-table="${e}"></i></span>`}m&&(m.innerHTML=s,m.querySelectorAll(".remove-filter").forEach(g=>{g.addEventListener("click",function(){const E=this.getAttribute("data-filter"),b=this.getAttribute("data-table");E==="search"?document.getElementById(b+"ProgramSearch").value="":E==="rating"?document.getElementById(b+"RatingFilter").value="":E==="type"?document.getElementById(b+"TypeFilter").value="":E==="initiative"&&(document.getElementById(b+"InitiativeFilter").value=""),p(b)})}))}document.querySelectorAll(`#${n} tbody tr`).forEach((s,g)=>{if(s.querySelector("td[colspan]"))return;const E=s.querySelector("td:first-child .fw-medium .program-name");if(!E)return;const b=E.textContent.trim();let u=null;if(typeof allPrograms<"u"&&(u=allPrograms.find(y=>(y.program_number?y.program_number+" ":"")+y.program_name===b||y.program_name===b)),!u){const y=s.querySelector("td:first-child .fw-medium"),w=y?.textContent.toLowerCase()||"",I=y?.querySelector(".badge.bg-info"),T=I?I.textContent.toLowerCase():"",L=s.querySelector("td:nth-child(2)"),B=L?.textContent.trim().toLowerCase()||"",A=L?.querySelector(".badge.bg-primary")!==null,x=s.querySelector("td:nth-child(3) .badge")?.textContent.trim().toLowerCase()||"",C=s.getAttribute("data-program-type")||"",F={"monthly target achieved":"target-achieved","on track for year":"on-track-yearly","on track":"on-track","severe delays":"severe-delay",delayed:"delayed",completed:"completed","not started":"not-started"}[x]||x;let S=!0;if(c&&!w.includes(c)&&!T.includes(c)&&(S=!1),f&&F!==f&&(S=!1),r&&C!==r&&(S=!1),a)if(a==="no-initiative")A&&(S=!1);else{const P=document.querySelector(`#${e}InitiativeFilter option[value="${a}"]`),q=P?P.textContent.toLowerCase():"";(!A||!B.includes(q))&&(S=!1)}S?s.classList.remove("d-none"):s.classList.add("d-none");return}let h=!0;if(c){const y=u.program_name.toLowerCase().includes(c),w=u.program_number?u.program_number.toLowerCase().includes(c):!1;!y&&!w&&(h=!1)}f&&u.rating!==f&&(h=!1),r&&(u.is_assigned==1?"assigned":"created")!==r&&(h=!1),a&&(a==="no-initiative"?u.initiative_id&&u.initiative_id!==null&&(h=!1):(!u.initiative_id||u.initiative_id!=a)&&(h=!1)),h?s.classList.remove("d-none"):s.classList.add("d-none")}),z(n),window.tablePaginations[n]&&window.tablePaginations[n].onFilterChange()}function M(){if(typeof TablePagination>"u"){console.error("TablePagination class is not available. Make sure pagination.js is loaded first.");return}document.getElementById("draftProgramsTable")&&(window.tablePaginations=window.tablePaginations||{},window.tablePaginations.draftProgramsTable=new TablePagination("draftProgramsTable",{itemsPerPage:5,paginationContainerId:"draftProgramsPagination",counterElementId:"draftProgramsCounter"})),document.getElementById("finalizedProgramsTable")&&(window.tablePaginations=window.tablePaginations||{},window.tablePaginations.finalizedProgramsTable=new TablePagination("finalizedProgramsTable",{itemsPerPage:5,paginationContainerId:"finalizedProgramsPagination",counterElementId:"finalizedProgramsCounter"}))}function _(){const e=document.querySelectorAll(".delete-program-btn"),n=document.getElementById("deleteModal");if(!n||!e.length)return;const t=document.getElementById("program-name-display"),i=document.getElementById("program-id-input");!t||!i||e.forEach(o=>{o.addEventListener("click",function(){const l=this.getAttribute("data-id"),d=this.getAttribute("data-name");t.textContent=d,i.value=l,new bootstrap.Modal(n).show()})})}function z(e){const n=document.querySelector(`#${e} tbody`);if(!n)return;if(Array.from(n.querySelectorAll("tr:not(.d-none)")).filter(i=>!i.querySelector("td[colspan]")).length===0){let i=n.querySelector(".no-filter-results");i||(i=document.createElement("tr"),i.className="no-filter-results",i.innerHTML='<td colspan="5" class="text-center py-4">No matching programs found.</td>',n.appendChild(i))}else{const i=n.querySelector(".no-filter-results");i&&i.remove()}}function N(){[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(t){return new bootstrap.Tooltip(t,{trigger:"hover focus",delay:{show:300,hide:100}})}),new MutationObserver(function(t){t.forEach(function(i){i.type==="childList"&&i.addedNodes.forEach(function(o){o.nodeType===1&&(o.querySelectorAll?o.querySelectorAll('[data-bs-toggle="tooltip"]'):[]).forEach(function(d){new bootstrap.Tooltip(d,{trigger:"hover focus",delay:{show:300,hide:100}})})})})}).observe(document.body,{childList:!0,subtree:!0})}function $(){document.querySelectorAll(".more-actions-btn").forEach(n=>{n.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation();const i=this.getAttribute("data-program-id"),o=this.getAttribute("data-program-name"),l=this.getAttribute("data-program-type");k(i,o,l)})})}function k(e,n,t){let i=document.getElementById("moreActionsModal");i||(i=R(),document.body.appendChild(i)),D(i,e,n,t),new bootstrap.Modal(i).show()}function R(){const e=document.createElement("div");return e.className="modal fade",e.id="moreActionsModal",e.setAttribute("tabindex","-1"),e.setAttribute("aria-labelledby","moreActionsModalLabel"),e.setAttribute("aria-hidden","true"),e.innerHTML=`
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="moreActionsModalLabel">
                        <i class="fas fa-ellipsis-v me-2"></i>Additional Actions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="program-info mb-3">
                        <h6 class="program-name-display"></h6>
                        <small class="text-muted program-type-display"></small>
                    </div>
                    <div class="actions-list">
                        <!-- Additional actions will be populated dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `,e}function D(e,n,t,i){const o=e.querySelector(".program-name-display"),l=e.querySelector(".program-type-display");o.textContent=t,l.textContent=i==="assigned"?"Assigned Program":"Agency-Created Program";const d=e.querySelector(".actions-list");d.innerHTML="",[{icon:"fas fa-edit",text:"Edit Submission",url:`edit_submission.php?program_id=${n}`,class:"btn-outline-success",tooltip:"Edit submissions for this program by selecting a reporting period"},{icon:"fas fa-paper-plane",text:"Submit Submission",action:"submit_submission",class:"btn-outline-info",tooltip:"Select and submit an existing draft submission"},{icon:"fas fa-edit",text:"Edit Program",url:`edit_program.php?id=${n}`,class:"btn-outline-warning",tooltip:"Modify program details, targets, and basic information"}].forEach(r=>{if(r.url){const a=document.createElement("a");a.className=`btn ${r.class} w-100 mb-2`,a.href=r.url,a.setAttribute("title",r.tooltip),a.setAttribute("data-bs-toggle","tooltip"),a.setAttribute("data-bs-placement","left"),a.innerHTML=`<i class="${r.icon} me-2"></i>${r.text}`,d.appendChild(a)}else if(r.action==="submit_submission"){const a=document.createElement("button");a.className=`btn ${r.class} w-100 mb-2 submit-submission-btn`,a.setAttribute("data-program-id",n),a.setAttribute("data-program-name",t),a.setAttribute("title",r.tooltip),a.setAttribute("data-bs-toggle","tooltip"),a.setAttribute("data-bs-placement","left"),a.innerHTML=`<i class="${r.icon} me-2"></i>${r.text}`,a.addEventListener("click",function(){const m=this.getAttribute("data-program-id"),v=this.getAttribute("data-program-name"),s=bootstrap.Modal.getInstance(document.getElementById("moreActionsModal"));s&&s.hide(),H(m,v)}),d.appendChild(a)}}),[].slice.call(d.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(r){return new bootstrap.Tooltip(r)})}function H(e,n){let t=document.getElementById("submissionSelectionModal");t||(t=j(),document.body.appendChild(t)),O(t,e,n),new bootstrap.Modal(t).show()}function j(){const e=document.createElement("div");return e.className="modal fade",e.id="submissionSelectionModal",e.setAttribute("tabindex","-1"),e.setAttribute("aria-labelledby","submissionSelectionModalLabel"),e.setAttribute("aria-hidden","true"),e.innerHTML=`
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="submissionSelectionModalLabel">
                        <i class="fas fa-paper-plane me-2"></i>Select Submission to Submit
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="program-info mb-3">
                        <h6 class="program-name-display"></h6>
                        <small class="text-muted">Select a draft submission to submit and finalize</small>
                    </div>
                    <div id="submissionsList">
                        <!-- Submissions will be loaded here -->
                    </div>
                    <div id="loadingSubmissions" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading submissions...</p>
                    </div>
                    <div id="noSubmissions" class="text-center py-4" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No Draft Submissions Found</h6>
                        <p class="text-muted">This program has no draft submissions available for submission.</p>
                        <a href="edit_submission.php?program_id=" class="btn btn-outline-primary">
                            <i class="fas fa-plus me-2"></i>Create New Submission
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    `,e}function O(e,n,t){const i=e.querySelector(".program-name-display"),o=e.querySelector("#submissionsList"),l=e.querySelector("#loadingSubmissions"),d=e.querySelector("#noSubmissions"),c=e.querySelector("#noSubmissions a");i.textContent=t,c.href=`edit_submission.php?program_id=${n}`,o.style.display="none",d.style.display="none",l.style.display="block",V(n,e)}function V(e,n){const t=n.querySelector("#submissionsList"),i=n.querySelector("#loadingSubmissions"),o=n.querySelector("#noSubmissions");fetch(`../ajax/get_program_submissions_list.php?program_id=${e}`).then(l=>l.json()).then(l=>{i.style.display="none",l.success&&l.submissions&&l.submissions.length>0?(t.innerHTML="",l.submissions.forEach(d=>{const c=Y(d,e);t.appendChild(c)}),t.style.display="block"):o.style.display="block"}).catch(l=>{console.error("Error loading submissions:",l),i.style.display="none",o.style.display="block";const d=o.querySelector("h6");d.textContent="Error Loading Submissions";const c=o.querySelector("p");c.textContent="An error occurred while loading submissions. Please try again."})}function Y(e,n){const t=document.createElement("div");t.className="card mb-3 submission-card",t.style.cursor="pointer",t.setAttribute("data-submission-id",e.submission_id),t.setAttribute("data-period-id",e.period_id),t.addEventListener("mouseenter",function(){this.style.transform="translateY(-2px)",this.style.boxShadow="0 4px 8px rgba(0,0,0,0.1)"}),t.addEventListener("mouseleave",function(){this.style.transform="translateY(0)",this.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)"}),t.addEventListener("click",function(){G(e.submission_id,e.period_id,n)});const i=e.period_status==="open"?'<span class="badge bg-success me-2">Open</span>':'<span class="badge bg-secondary me-2">Closed</span>';return t.innerHTML=`
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="card-title mb-2">
                        <i class="fas fa-calendar-alt me-2 text-primary"></i>
                        ${e.period_display}
                        ${i}
                    </h6>
                    <p class="card-text text-muted mb-2">
                        <i class="fas fa-file-alt me-1"></i>
                        ${e.description}
                    </p>
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Last updated: ${e.submitted_at||"Not specified"}
                    </small>
                </div>
                <div class="text-end">
                    <i class="fas fa-chevron-right text-muted"></i>
                </div>
            </div>
        </div>
    `,t}function G(e,n,t){const i=bootstrap.Modal.getInstance(document.getElementById("submissionSelectionModal"));i&&i.hide(),window.location.href=`edit_submission.php?program_id=${t}&period_id=${n}`}
